name: Build and Release Windows Executable

on:
  push:
    tags:
      - 'v*'
      - '[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for manual release'
        required: false

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
      
      - name: Build JAR with Gradle
        run: gradle jar --no-daemon
      
      - name: Create jpackage directory
        run: mkdir jpackage-input
      
      - name: Copy JAR to jpackage input
        run: |
          if (Test-Path build\libs\woodlanders-client.jar) {
            Write-Host "Found woodlanders-client.jar"
            Copy-Item build\libs\woodlanders-client.jar -Destination jpackage-input\woodlanders.jar
          } else {
            Write-Error "woodlanders-client.jar not found in build/libs"
            Write-Host "Available files:"
            Get-ChildItem -Path build\libs
            exit 1
          }
      
      - name: Verify JAR exists
        run: |
          if (Test-Path jpackage-input\woodlanders.jar) {
            Write-Host "JAR file found successfully"
            Get-Item jpackage-input\woodlanders.jar
          } else {
            Write-Error "JAR file not found!"
            exit 1
          }
      
      - name: Create portable Windows executable with jpackage
        run: |
          jpackage `
            --input jpackage-input `
            --name Woodlanders `
            --main-jar woodlanders.jar `
            --type app-image `
            --dest dist `
            --app-version 1.0.0 `
            --vendor "Wagemaker UK" `
            --description "Woodlanders Game" `
            --win-console
      
      - name: Create portable ZIP package
        run: |
          cd dist
          Compress-Archive -Path Woodlanders -DestinationPath Woodlanders-Windows-Portable.zip
      
      - name: Get tag name
        id: get_tag
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "push" ] && [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
            echo "is_tag=true" >> $GITHUB_OUTPUT
            echo "Detected tag: $TAG_NAME"
          elif [ -n "${{ github.event.inputs.tag_name }}" ]; then
            echo "tag_name=${{ github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
            echo "is_tag=true" >> $GITHUB_OUTPUT
            echo "Manual tag: ${{ github.event.inputs.tag_name }}"
          else
            echo "is_tag=false" >> $GITHUB_OUTPUT
            echo "No tag detected"
          fi
      
      - name: Create GitHub Release
        if: steps.get_tag.outputs.is_tag == 'true'
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_tag.outputs.tag_name }}
          name: Release ${{ steps.get_tag.outputs.tag_name }}
          draft: false
          prerelease: false
          files: ./dist/Woodlanders-Windows-Portable.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload artifact for manual download
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: Woodlanders-Windows-Portable
          path: dist/Woodlanders-Windows-Portable.zip
